<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Kimi Flask 流式聊天</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Arial", "Microsoft YaHei", sans-serif; background: #f5f5f5; }
        .container { max-width: 900px; margin: 20px auto; padding: 0 20px; }
        .chat-box { 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .chat-history { 
            height: 450px; 
            padding: 20px; 
            overflow-y: auto; 
            border-bottom: 1px solid #eee;
        }
        .message { margin-bottom: 15px; line-height: 1.6; }
        .user-message { text-align: right; }
        .user-content { 
            display: inline-block; 
            background: #4285f4; 
            color: white; 
            padding: 10px 15px; 
            border-radius: 18px 18px 4px 18px;
            max-width: 70%;
        }
        .kimi-message { text-align: left; }
        .kimi-content { 
            display: inline-block; 
            background: #f1f3f4; 
            color: #333; 
            padding: 10px 15px; 
            border-radius: 18px 18px 18px 4px;
            max-width: 70%;
        }
        .input-area { 
            padding: 20px; 
            display: flex; 
            gap: 10px;
        }
        #input-text { 
            flex: 1; 
            padding: 12px 15px; 
            border: 1px solid #ddd; 
            border-radius: 25px; 
            font-size: 14px;
            resize: none;
            height: 80px;
        }
        #send-btn { 
            padding: 0 25px; 
            background: #4285f4; 
            color: white; 
            border: none; 
            border-radius: 25px; 
            cursor: pointer; 
            font-size: 16px;
        }
        #send-btn:disabled { background: #ccc; cursor: not-allowed; }
        .loading { color: #666; font-style: italic; }
    </style>
        <style>
        .message-bubble {
            /* 气泡主体样式 */
            width: 200px;
            height: 80px;
            background: #4285f4; /* 气泡颜色 */
            border-radius: 6px; /* 圆角 */
            position: relative; /* 用于定位三角 */
            margin: 50px; /* 外边距，方便查看 */
        }

        /* 右侧中间的小三角 */
        .message-bubble::after {
            content: '';
            position: absolute;
            top: 50%; /* 垂直居中 */
            right: -10px; /* 超出气泡右侧 */
            transform: translateY(-50%); /* 垂直居中对齐 */
            /* 绘制三角形（CSS 三角形原理：边框透明，单边有色） */
            border-width: 10px 0 10px 10px; /* 上、下、左的边框宽度 */
            border-style: solid;
            border-color: transparent transparent transparent #4285f4; /* 左边框颜色与气泡一致 */
        }
    </style>

</head>
<body>
    <div class="container">
        <div class="chat-box">
            <!-- 聊天历史区域 -->
            <div class="chat-history" id="chat-history">
                <div class="message kimi-message">
                    <div class="kimi-content">你好！我是Kimi AI助手，很高兴为你服务！</div>
                </div>
            </div>
            <!-- 输入区域 -->
            <div class="input-area">
                <textarea id="input-text" placeholder="请输入消息..."></textarea>
                <button id="send-btn" onclick="sendMessage()">发送</button>
            </div>
        </div>
    </div>

    <script>
        // 对话历史（存储 {role, content} 格式，用于多轮对话）
        let chatHistory = [];
        const chatHistoryDom = document.getElementById("chat-history");
        const inputText = document.getElementById("input-text");
        const sendBtn = document.getElementById("send-btn");

        // 发送消息并处理流式响应
        async function sendMessage() {
            const prompt = inputText.value.trim();
            if (!prompt) return;

            // 1. 清空输入框 + 禁用按钮
            inputText.value = "";
            sendBtn.disabled = true;

            // 2. 添加用户消息到页面
            addMessageToDom("user", prompt);
            // 3. 记录对话历史
            chatHistory.push({ role: "user", content: prompt });

            // 4. 发送流式请求
            try {
                const response = await fetch("/api/stream", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        prompt: prompt,
                        history: chatHistory  // 传递对话历史，支持多轮
                    })
                });

                if (!response.ok) throw new Error(`HTTP错误：${response.status}`);

                // 5. 处理流式响应（打字机效果）
                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let kimiMessageDom = addMessageToDom("kimi", "", true);  // 占位加载
                let fullContent = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    // 解析 SSE 格式数据
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split("\n\n").filter(line => line);

                    for (const line of lines) {
                        if (line.startsWith("data: ")) {
                            const dataStr = line.slice(6);
                            const data = JSON.parse(dataStr);

                            if (data.error) {
                                kimiMessageDom.innerHTML = `<span style="color: red;">${data.error}</span>`;
                                return;
                            }
                            if (data.end) {
                                // 记录 Kimi 回复到历史
                                chatHistory.push({ role: "assistant", content: fullContent });
                                break;
                            }
                            if (data.content) {
                                fullContent += data.content;
                                kimiMessageDom.innerHTML = fullContent;  // 逐段更新，打字机效果
                            }
                        }
                    }
                }

            } catch (error) {
                addMessageToDom("kimi", `<span style="color: red;">连接失败：${error.message}</span>`);
            } finally {
                sendBtn.disabled = false;  // 恢复按钮
            }
        }

        // 添加消息到页面 DOM
        function addMessageToDom(sender, content, isLoading = false) {
            const messageDiv = document.createElement("div");
            messageDiv.className = `message ${sender}-message`;

            const contentDiv = document.createElement("div");
            contentDiv.className = `${sender}-content`;
            contentDiv.innerHTML = isLoading ? '<span class="loading">Kimi 正在回复...</span>' : content;

            messageDiv.appendChild(contentDiv);
            chatHistoryDom.appendChild(messageDiv);
            // 滚动到底部
            chatHistoryDom.scrollTop = chatHistoryDom.scrollHeight;

            return contentDiv;  // 返回内容 DOM，用于流式更新
        }

        // 绑定回车键发送（Shift+Enter 换行）
        inputText.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html>